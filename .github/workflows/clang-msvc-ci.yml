name: Clang MSVC Sysroot CI

on:
  push:
  pull_request:

jobs:
  test-msvc-sysroot:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout project
      uses: actions/checkout@v3
      with:
        fetch-depth: 1
    - name: Install Clang and LLD
      run: |
        sudo apt update
        sudo apt install -y clang lld

    - name: Show Clang version
      run: clang++ --version

    - name: Prepare test source
      run: |
        mkdir -p build
        cat > build/hello.cpp <<EOF
        #include <windows.h>
        #include <iostream>
        #include <winrt/base.h>

        int main() {
          MessageBoxW(NULL, L"Hello from MSVC sysroot!", L"CI Test", MB_OK);
          std::wcout << L"Hello World from C++ and Windows headers!\n";

          winrt::hstring msg = L"Hello from winrt::hstring!\n";
          std::wcout << msg.c_str();
        }
        EOF

    - name: Compile all triplet + stdlib combinations
      run: |
        SYSROOT="${{ github.workspace }}"
        TRIPLETS=("i686-unknown-windows-msvc" "x86_64-unknown-windows-msvc" "aarch64-unknown-windows-msvc")
        STDLIBS=("msstl" "libc++")

        for triplet in "${TRIPLETS[@]}"; do
          for stdlib in "${STDLIBS[@]}"; do
            echo "Compiling for $triplet with $stdlib..."

            STDINCLUDE="$SYSROOT/include"
            CPPINCLUDE="$SYSROOT/include/c++/$stdlib"
            LIBDIR="$SYSROOT/lib/${triplet}"

            clang++ build/hello.cpp \
              --target=$triplet \
              -I"$STDINCLUDE" -I"$CPPINCLUDE" \
              -L"$LIBDIR" \
              -fuse-ld=lld \
              -O2 \
              -D_DLL=1 \
              -lmsvcrt \
              -std=c++20 \
              -o build/hello_${triplet}_${stdlib}.exe

            file build/hello_${triplet}_${stdlib}.exe
          done
        done

